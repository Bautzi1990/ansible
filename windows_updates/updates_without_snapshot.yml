---
# Install updates on Windows-Server
# Kein VMware-Snapshot
# Abarbeitung nacheinander, nicht parallel

- name: Windows-Updates mit VMware-Snapshot
  hosts:
    - all
  serial:
    - 1
  #  strategy: free
  
  tasks:
    - name: Logfile auf Remote Server loeschen
      ansible.windows.win_file:
        path: C:/ansible_{{ inventory_hostname }}.txt
        state: absent

    - name: search and install updates und Logfile schreiben
      win_updates:
        category_names:
          - CriticalUpdates
          - SecurityUpdates
          - UpdateRollups
          - Updates
            #state: searched
        reboot: yes
        reboot_timeout: 1200
        log_path: c:\ansible_{{ inventory_hostname }}.txt
      register: update_result

    - name: Update-Log abholen
      fetch:
        src: C:/ansible_{{ inventory_hostname }}.txt
        dest: /tmp/
        flat: yes
      register: update_result

#    - name: Update-Status per Mail
#      community.general.mail:
#        host: localhost
#        port: 25
#        # to: "{{ mail_to }}"
#        to: "karl.grosse.vogelsang@bsb-buchstelle.de"
#        subject: "Ansible Report"
#        # {{ ansible_hostname }}
#        # attach: /tmp/ansible_{{ inventory_hostname }}.txt
#        body: "System has been successfully provisioned."

    - name: Example playbook sending mail to root
      community.general.mail:
        subject: System {{ ansible_hostname }} has been successfully provisioned.
      delegate_to: localhost
